<!doctype html>
<head>
	<meta charset="utf-8"/>
	<title>GFL cutscene interpreter</title>
	
	<!--For discord description -->
	<meta property="og:title" content="Girls' Frontline Cutscene Interpreter" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://gfl.amaryllisworks.pw" />
	<!--<meta property="og:image" content="http://my.site.com/images/thumb.png" />-->
	<meta property="og:description" content="Play back cutscenes in the browser" />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	
	<!--Resources -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	 <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500&display=swap" rel="stylesheet">  
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--<link type="text/css" rel="stylesheet" href="materialize.css"  media="screen,projection"/>-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>
<style type="text/css">
body
{
	/*background-color: black;
	color: white*/
	text-align:center;
}

/*button
{
	background-color: black;
	color:white;
}*/

table, th, td {
   border: 1px solid #222222;
   border-collapse: collapse;
}
th {
	background-color: purple;
}

/*#head, #foot {
	height: 6%;
	min-height: 25px;
	width: 100%;
	background-color: #151515;
	overflow: hidden;
}

#head a {
  float: left;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}


#head a:hover {
  background-color: #ddd;
  color: black;
}

#head a.active {
  background-color: #4CAF50;
  color: white;
}*/

.tabs {
    display:-webkit-flex;
    display: -ms-flexbox;
    display: flex
}




.flex-container {
  display: flex;
  flex-wrap: wrap;
  background-color: DodgerBlue;
  justify-content: center;
  align-items: center;
}

.flex-container > div {
  background-color: #f1f1f1;
  margin: 5px;
  /*padding: 20px;
  font-size: 30px;*/
}

tr:nth-child(odd) {
    background-color: #000000CC;
}
tr:nth-child(even) {
    background-color: #111111CC;
}

#verySimpleText{
	text-align: left;
	width: 700px;
	margin: 0 auto;
	font-family: 'Noto Sans KR', sans-serif;
}

/*.container {
  position: relative;
  text-align: center;
  color: white;
}

.charName {
  font-family: 'Noto Sans KR', sans-serif;
  position: absolute;
  top: 5px;
  left: 16px;
  font-size: 2vw;
}

.absText {
      font-family: 'Noto Sans KR', sans-serif;
  position: absolute;
  top: 45px;
  left: 16px;
  font-size: 2.2vw;
}*/


/*.speakerName{
	font-weight: bold;
}*/

.storyText {
	margin-top: 0.5ex;
	margin-bottom: 0.5ex;
}

.storyText.speakerName {
	margin-top: 0;
	font-weight: bold;
}

/*
Blatantly stolen from gfl.zzzzz.kr 
I have no idea how it works
*/
.storyImg{
	position:relative;
	overflow:hidden; /*Keep portraits within div */
	width:700px;
	padding-top:1rem;
}
.storydoll{
	width:500px; /*Why is width 500px? */
	position: absolute;
	bottom: -30%;
	z-index: 5;
}
.storydoll.one{
	left:15%; /*???*/
}
.storydoll.first.two{
	right:25%
}
.storydoll.second.two{
	left:35%
}

.storydoll.dim{
	filter: brightness(50%);
	z-index:4;
}

/*.storydoll.saying{
	filter: brightness(100%);
	z-index: 100;
}*/

#SearchResults {
	cursor: pointer;
	display: block;
	text-align: left;
}
/*lol */
.collection-item.waves-effect {
	display: inherit;
}

</style>
<script type="text/javascript"></script>
<!-- tfw no bandwidth -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<!--<script type="text/javascript" src="materialize.js"></script>-->
<!--<script src="phaser.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
<script>
	/*
	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program.  If not, see <https://www.gnu.org/licenses/>.

	This program is written by Rhythm Lunatic.
	*/
	
	/*
		Just gonna say it right now, I don't know an ounce of JavaScript or phaser.
		I interpreted lua and my game engine knowledge until this worked.
		
		So that's the answer as to why the chapter select looks like dogshit. Make a PR if you want it to be fixed.
	*/

	/* opcode dictionary
		Seriously who designed this, can't you use normal fucking opcodes?
		XXX() - Set portrait. XXX is character sprite. Can have multiple of these. Actually does not need to be the first OPCODES
		; - Unknown purpose. Could be used for switching highlights? Seems to separate two portrait opcodes.
		<BGM> - Set BGM
		<BIN> - Set background
		<Speaker> - Set the speaker name
		|| - Separator. Things after this separator will be run later, maybe? Usually transition commands, shake effects, etc are after these
		<黑点X> - Black dot screen transition. X=1 for in, 2 for out.
		<黑屏X> - Black screen fade in and out
		<通讯框> - "Communication box". Display character portrait inside a communication box.
		<震屏> - Screen shake effect
		: - End of opcodes, text goes here (Other than +)
		+ - End text. Text will continue in a new box (no close/open animation) when clicked.
		
	*/
	//I kept accidentally typing print ok
	window.print = function(param)
	{
		console.log(param);
	}
	function consoleWarn(param)
	{
		console.log("%c "+param,'background: black; color: yellow')
	}
	
	
	//FOR T-DOLL DISPLAY
	gfcolors = [
		"#000000", //NPCs & SF - Black?
		"0",        //Nothing has 1 stars.
		"#adadad", //2 stars   - Grey
		"#6bdfce", //3 stars   - Turquoise
		"#d6e35a", //4 stars   - Green
		"#ffb600", //5 stars   - Orange
		"#ff6a00", //6 stars   - Orange
		"#dfb6ff"  //EXTRAstar - Purple
	]
	
	function num2stars(div, numStars)
	{
		var _star_ = document.createElement("i");
		_star_.className = "material-icons";
		
		if (numStars < 1)
		{
		
		}
		else if (numStars == 7)
		{
			var star = _star_.cloneNode(false);
			star.innerHTML = "stars"
			star.style.color = gfcolors[7];
			div.appendChild(star);
		}
		else if (numStars > 5)
		{
			for (var j=0;j<numStars;j++)
			{
				var star = _star_.cloneNode(false);
				star.innerHTML = "star";
				star.style.color = gfcolors[numStars];
				div.appendChild(star);
			}
		}
		else
		{
			for (var j=0;j<5;j++)
			{
				var star = _star_.cloneNode(false);
				if (j < numStars)
					star.innerHTML = "star";
				else
					star.innerHTML = "star_border";
				star.style.color = gfcolors[numStars];
				div.appendChild(star);
			}
		}
	}
	
	//interpreter related
	
	const OPCODES = {
		BGM : 1,
		BG : 2,
		SPEAKER : 3,
		MSG : 4,
		PORTRAIT : 5,
		NOPORTRAIT : 6,
		MSGBOXTRANSITION : 7,
		//SETMASKEDPORTRAIT : 8
	}
	
	//For JSON structured or making your own
	//Pro tip: use opcode2string.indexOf(s) to get the opcode number
	const opcode2string = [
		'none',
		'bgm',
		'bg',
		'speaker',
		'msg',
		'portrait',
		'noPortrait',
		'msgboxTransition',
		//'setMaskedPortrait'
	]
	
	const tag2opcode = {
		"Speaker":OPCODES.SPEAKER,
		"BIN":OPCODES.BG,
		"BGM":OPCODES.BGM,
		//"通讯框":OPCODES.SETMASKEDPORTRAIT,
	}
	
	const backgrounds = {
		1: "树林",
		2: "机场",
		3: "街道",
		4: "主界面背景",
		6: "冰湖",
		7: "雪地",
		8: "作战室avg",
		9: "black",
		10: "PlaybackBG1",
		15: "室内战斗",
		17: "ANTIRAIN",
		18: "单挑",
		19: "SFs",
		22: "工厂背景avg",
		89: "BG-WarehouseON",
		99: "BG-WildBattle"
	}
	
	//To be loaded later.
	let PORTRAITS = undefined;
	
	//For CSS
	var int2str = ['zero','one',  'two',   'three','four',  'five', 'six',  'seven',  'eight', 'nine']
	var int2strPos = ['N','first','second','third','fourth','fifth','sixth','seventh','eighth','ninth']
	
	//I moved everything to gfl subdomain so it's fine now
	//const portraitWebserver = "http://gfl.amaryllisworks.pw/pic/"
	
	function portraitStructToString(p)
	{
		return "idx: "+p[1]+" | name: "+p[2]+" | type: "+p[3]+" | dim: "+p[4]+" | isMasked: "+p[5]
	}
	
	//Don't care if it's all over the place. Fix it yourself. If this was SM I'd be using broadcasts anyways
	var nameActor;
	var bgActor;
	
	function loadBG(runtime, num)
	{
		console.log("Loading "+num+" | "+backgrounds[num])
		runtime.load.once('complete',function() { bgActor.setTexture(num);bgActor.displayWidth = 1280;bgActor.displayHeight= 720; },runtime)
		runtime.load.image(num,'avgtexture/'+backgrounds[num]+'.png');
		runtime.load.start();
	}
	
	//A pool of portraits since there's gonna be more than one
	var portraitCollection = []
	function loadPortrait(runtime,idx,name,type)
	{
		if (PORTRAITS[name] != undefined && PORTRAITS[name][type] != undefined)
		{
			let keyedPortrait=name+'-'+type;
			let fileName = PORTRAITS[name][type]
			console.log("Loading "+fileName);
			if (idx > portraitCollection.length-1)
			{
				runtime.load.once('complete',function() { portraitCollection.push( runtime.add.image(game.config.width/2,game.config.height-100,keyedPortrait) ) } );
			}
			else
			{
				runtime.load.once('complete',function() { portraitCollection[idx].setTexture(keyedPortrait) } );
			}
			runtime.load.image(keyedPortrait,'pic/'+fileName);
			runtime.load.start();
		}
		else
		{
			console.log("Portrait "+name+" missing from database.")
		}
	}
	
	//var interval;
	//Yes, I did translate it from lua. Lmao.
	class VNText4 {
		constructor(phaserRuntime,font,maxwidth,spd,msgTable)
		{
			this.phaserRuntime = phaserRuntime; //lol
			this.cur_len = 0;
			this.spd = spd;
			this.curIndex = 0;
			this.msgTable = msgTable;
			
			this.textActor = phaserRuntime.add.text(0,0,'Static Text Object', { fontFamily: 'Noto Sans KR', fontSize: 27, color: '#ffffff', wordWrap: {width:maxwidth,useAdvancedWrap:true} });
		}
		is_finished()
		{
			return this.cur_len == this.text.length;
		}
		
		//In StepMania you can just chain a command (within an actor) with sleep over and over, but in phaser you have to attach it to the game engine?
		//Attaching tweens to the game engine instead of actors is kind of a weird decision by the way, why wouldn't you attach them to the actor?
		//I'm using setInterval anyways
		play()
		{
			
			let f = function(self){
				self.cur_len = self.textActor.text.length;
				//console.log(self.cur_len+"/"+self.text.length);
				if (self.cur_len < self.text.length)
				{
					let txt = self.text.slice(0,self.cur_len+1)
					//console.log(txt);
					self.textActor.setText(txt);
				}
				else
				{
					clearInterval(f);
				}
			}
			
			f(this);
			
			//console.log(1/this.spd*1000);
			let interval = setInterval(f,1/this.spd*1000,this);
			//This can't possibly be high performance...
			
			/*phaserRuntime.tweens.add({
				targets:this.textActor,
				ease:'Linear',
				duration:1/this.spd,
				onComplete:this.play
			)}*/
				
			
		}
		Text()
		{
			this.cur_len = this.textActor.text;
			if (this.cur_len < this.text.length)
				this.textActor.setText(this.text.slice(0,this.cur_len));
		}
		advance()
		{
			if (this.no_more_text())
				return;
			//this.curIndex++;
			var noMsgYet = true;
			while (noMsgYet)
			{
				console.assert(this.msgTable[this.curIndex],"There is no opcode located at "+this.curIndex+". How did you even get this far?")
				let curMsg = this.msgTable[this.curIndex]
				let MsgOpcode = curMsg[0]
				//console.log(opcode)
				//console.log(this.curIndex);
				//console.log(MsgOpcode == OPCODES.MSG);
				switch(MsgOpcode) {
					case OPCODES.MSG:
						this.cur_len= 0
						this.text = curMsg[1]
						//this.text_actor:queuecommand("Check")
						noMsgYet = false;
						break;
					case OPCODES.SPEAKER:
						nameActor.setText(curMsg[1]);
						break;
					case OPCODES.BG:
						loadBG(this.phaserRuntime,curMsg[1]);
						break;
					case OPCODES.PORTRAIT:
						console.log(portraitStructToString(curMsg))
						loadPortrait(this.phaserRuntime,curMsg[1],curMsg[2],curMsg[3])
						break;
					//lua junk from my message system. Just ignore it.
					/*case OPCODESFMSG:
						this.cur_len= 0
						this.text = this.msgTable[this.curIndex][2]()
						//this.text_actor:queuecommand("Check")
						break outLoop;
					elseif opcode == "func" then
						this.msgTable[this.curIndex][2]()
					elseif opcode == "choice" then
						ChoiceTable = {Result=1,Finished=false}
						assert(this.msgTable[this.curIndex][2],"Choice table is invalid.")
						ChoiceTable.Choices = this.msgTable[this.curIndex][2]
						assert(ChoiceTable.Choices)
					elseif opcode == "exit" then
						return false;
					elseif opcode == "condJumpSS" then
						Trace(table_print(this.selfSwitches))
						Trace(table_print(this.msgTable[this.curIndex]))
						if this.selfSwitches[this.msgTable[this.curIndex][2]] == true then
							//Subtract 1 to account for advance advancing one step, since we want to start on whatever it jumps to
							this.curIndex = this.msgTable[this.curIndex][3]-1
							Trace("Jumped to index "..this.curIndex)
						end
					elseif opcode == "condJump" then
						if this.msgTable[this.curIndex][2]() == true then
							//Subtract 1 to account for advance advancing one step, since we want to start on whatever it jumps to
							this.curIndex = this.msgTable[this.curIndex][3]-1
							Trace("Jumped to index "..this.curIndex)
						end
					elseif opcode == "selfSwitch" then
						this.selfSwitches[this.msgTable[this.curIndex][2]] = this.msgTable[this.curIndex][3]
					end;*/
				}
				this.curIndex++;
				//console.log(noMsgYet);
			}
			//Trace(this.text)
			//lua.Flush();
			//this.text_actor:settext(""):playcommand("Check");
			//console.log(this.text)
			document.getElementById('curIndexDebug').innerText="idx: "+(this.curIndex-1)+" | msg: "+this.msgTable[(this.curIndex-1)].toString()
			this.textActor.setText('');
			this.play();
		}
		no_more_text()
		{
			return this.curIndex >= this.msgTable.length-1;
		}
		skip()
		{
			this.textActor.setText(this.text);
			this.cur_len = this.text.length;
		}
	}
	
	/*class SpriteActor() {
		constructor()
		{
			//this.
		}
	}*/
	
	function sliceAndRemove(str, begin, end)
	{
		return str.slice(0,begin)+str.slice(end)
	}
	
	function getFromTag(str,tag)
	{
		const beginTag = "<"+tag+">"
		const endTag = "</"+tag+">"
		var n = str.indexOf(beginTag)
		if (n != -1){
			return str.slice(n+beginTag.length, str.indexOf(endTag))
		}
		return null
	}
	function removeTag(str,tag)
	{
		const beginTag = "<"+tag+">"
		const endTag = "</"+tag+">"
		return sliceAndRemove(str,str.indexOf(beginTag),str.indexOf(endTag)+endTag.length)
	}
	
	
	
	let curEpisodePart = 0
	class GirlsFrontlineScene extends Phaser.Scene {
		constructor()
		{
			//I don't know what this does but the tutorial had it
			super('GirlsFrontlineScene');
		}
		
		 preload()
		{
			//this.load.image('test','test.png');
			this.load.image('textbox','textbox.png');
		}
		
		create()
		{
			//input.touch only works on mobile devices. So it will break on desktop. reeeee
			//game.input.touch.capture = false;
			
			//GFL, in all of it's genius, uses 1024x1024 images. With black borders.
			/*bgActor = this.make.image({ x:game.config.width/2, y:game.config.height/2, add:true });
			bgActor.displayWidth = 1024
			bgActor.displayHeight= 1024*/
			bgActor = this.add.image(game.config.width/2,game.config.height/2);
			bgActor.texture = Phaser.Cache.DEFAULT;
			bgActor.setDepth(0);
			
			/*var img = this.make.image({ x:game.config.width/2, y:game.config.height/2, key:'test',add:true })
			img.displayWidth = game.config.width
			img.displayHeight= game.config.height
			img.setDepth(1);*/
			
			//Depth 2 is reserved for character portraits!
			
			imageActor = this.make.image({
				x:game.config.width /2,
				y:game.config.height-125,
				//scale:1,
				key:'textbox',
				add:true
			})
			imageActor.scaleY = 1
			imageActor.setDepth(3);
			
			//var blocks = this.add.group({ key: 'block', repeat: 139, setScale: { x: 0, y: 0 } });
			
			nameActor = this.add.text(240,500,'', { fontFamily: 'Noto Sans KR', fontSize: 30, color: '#ffffff' });
			nameActor.setDepth(4);
			
			//TODO
			document.getElementById("DebugTextArea").value = structuredLinesToString(currentEpisodeAsOpcodes[curEpisodePart]);
			
			vntext = new VNText4(this,'',800,13,currentEpisodeAsOpcodes[curEpisodePart]);
			vntext.textActor.x = 242;
			vntext.textActor.y = game.config.height-160
			vntext.textActor.setDepth(4);
			vntext.advance();
			
			this.input.on('pointerdown',function(){
				if (vntext.no_more_text())
				{
					console.log("Already hit the end!!!!");
					//'this' isn't passed in... No idea what I'm gonna do
					//If you spam click it will crash because you're removing and trying to add multiple scenes at the same time
					//this.input.onInputDown.removeAll();
					if (curEpisodePart < currentEpisodeAsOpcodes.length)
					{
						curEpisodePart++;
						game.scene.remove('GirlsFrontlineScene');
						game.scene.add('GirlsFrontlineScene',GirlsFrontlineScene,true);
					}
					else
					{
						//Oh no
						goToNextEpisode()
					}
					
				}
				else
				{
					if (vntext.is_finished())
					{
						vntext.advance();
					}
					else
					{
						vntext.skip();
					}
				}
			},vntext)
			//Hey look it's just like StepMania
			/*this.make.text({
				x: 100,
				y: 100,
				text: 'Phaser III',
				style: {
					fontSize: '48px',
					fontFamily: 'Arial',
					color: '#ffffff',
					metrics: {
						ascent: 45,
						descent: 10,
						fontSize: 55
					}
				}
			})*/
		}
		
		//I'm not even using this lmao
		 update()
		{
			
		}
	}
	
	let config = {
		type: Phaser.WEBGL,
		width: 1280,
		height: 720,
		parent: 'phaser',
		/*scene: {
			preload: preload,
			create: create,
		}*/
		scene: [GirlsFrontlineScene]
	};
	
	//phaser
	var game;
	
	var imageActor;
	var vntext;
	

	
	function convertGFLTextToOpcodes(out)
	{
		//console.log(out);
		var lines = out.split(/\r?\n/);
		//The GFL text system is stupid as fuck and I just spent a whole week writing my own VN system
		//So obviously I'm going to convert it to my own. fuck you
		//console.log(lines)
		//Fuck your opcodes
		let structuredLines = [];
		
		
		//It's really stupid but flipDim has to know the state of the previous dimmed portraits because normally the GFL engine only supports two portraits and I wanted more
		let prevLineHadAtLeastTwoPortraits = false;
		let flipDim = false;
		for(i=0;i<lines.length;i++)
		{
			if (!lines[i])
				continue;
			//print(lines[i]);
			let [cmds,text] = lines[i].replace("：",':').split(':')
			console.assert(cmds,lines[i])
			//console.assert(text,lines[i])
			
			//Yeah I know tags are supposed to be in order, No I don't really care sorry
			const tags = ["Speaker","BGM","BIN"]
			tags.forEach(tag => {
				//console.log(tag);
				let tagRes = getFromTag(cmds,tag);
				//console.log(tagRes)
				if (tagRes != null)
				{
					structuredLines.push([tag2opcode[tag],tagRes])
					removeTag(cmds,tag)
				}
			})
			//const tags = [
			var nextPortraitIsMasked = false;
			if (cmds.includes("<通讯框>"))
			{
				nextPortraitIsMasked = true;
				//structuredLines.push([OPCODES.SETMASKEDPORTRAIT])
				cmds=cmds.replace("<通讯框>","");
			}
			
			
			//So portraits are set in any order... But how the fuck are you supposed to tell when a name is if there's <> tags
			//I'm just going to search portraits after removing <> tags, it probably won't matter
			let numPortraits = 0;
			let thisLineHadAtLeastTwoPortraits = (cmds.indexOf(";") != -1)
			if (thisLineHadAtLeastTwoPortraits && prevLineHadAtLeastTwoPortraits)
				flipDim = !flipDim;
			//console.log(thisLineHadAtLeastTwoPortraits);
			//Limit it to 5 because I don't want a dumb infinite loop that crashes the browser
			for(j=0;j<5;j++)
			{
				//console.log(cmds)
				let charTagEnd = cmds.indexOf(")");
				if (charTagEnd != -1)
				{
					//It's +1 to get rid of the ;
					let charTagStart = Math.max(cmds.lastIndexOf(";",charTagEnd)+1,0)
					let [charID,charSpr] = cmds.slice(charTagStart,charTagEnd).split("(")
					//console.log(charID)
					//console.log(charSpr)
					//Ignore empty sprite IDs, they do nothing.
					if (charSpr != "")
					{
						let shouldDim = false;
						if (thisLineHadAtLeastTwoPortraits)
						{
							shouldDim = flipDim ? j==0 : j != 0;
						}
						structuredLines.push([OPCODES.PORTRAIT,numPortraits,charID,charSpr,shouldDim,nextPortraitIsMasked])
						nextPortraitIsMasked = false;
						numPortraits++;
					}
					//I think speaker name gets cleared if it's ()? Not sure
					//Portrait gets cleared
					else
					{
						structuredLines.push([OPCODES.NOPORTRAIT])
						//structuredLines.push([OPCODES.SPEAKER,""])
						//numPortraits=0;
					}
					cmds = sliceAndRemove(cmds,charTagStart,charTagEnd+1);
				}
				else
				{
					//console.log("Done... Let's exit");
					break;
				}
			}
			prevLineHadAtLeastTwoPortraits = thisLineHadAtLeastTwoPortraits;
			/**/
			
			//Now do text... But first check if there is any text (some lines are only commands)
			if (text)
			{
				text.split("+").forEach(msg => {
					structuredLines.push([OPCODES.MSG,msg])
				})
			}
			//open/close msgbox
			structuredLines.push([OPCODES.MSGBOXTRANSITION])
		}
		return structuredLines;
	}
	
	var curEpKey;
	var currentEpisodeAsOpcodes;
	
	//WHY DOES IT HAVE TO BE A SEPARATE FUNCTION
	/*async function fetchTextFile(fileName)
	{
		console.log("fetching "+fileName);
		const response = await fetch("avgtxt/"+fileName);
		console.log("got "+fileName);
		return await response.text();
		//const out = await response.text();
		//return out;
	}*/
	
	function structuredLinesToString(structuredLines)
	{
		let s = "";
		structuredLines.forEach(line => {
			s+=opcode2string[line[0]]+';'
			/*for(var i=1;i<line.length;i++)
				s+=line[i]*/
			s+=line.slice(1).join([separator = ';'])
			s+='\r\n'
			//s+=line.toString()+"\r\n";
		})
		return s;
	}
	function stringToStructuredLines(s)
	{
		var lines = s.split(/\r?\n/);
		let structuredLines = [];
		for(i=0;i<lines.length;i++)
		{
			let newMsg = lines[i].split(';')
			newMsg[0] = opcode2string.indexOf(newMsg[0])
			structuredLines.push(newMsg)
		}
		return structuredLines;
	}
	
	//You're probably wondering why the fuck there's two of these functions when a routableKeyString is always passed in
	//That's because I want to support running from an episode object without the keyString (for user stuff)
	function runFromRoutableKeyString(value)
	{
		if (value == undefined)
			value = curEpKey;
		let [type,chapter,episode] = getKeysFromRoutableString(value)
		run(listOfChapters[type][chapter]['episodes'][episode],value)
	}
	
	async function run(episode, routableKeyString)
	{
		currentEpisodeAsOpcodes = [];
		curEpisodePart = 0;
		curEpKey = routableKeyString;
		
		
		document.getElementById('chapterName').innerText = episode['name'];
		
		//Instead of just one part, put all of them in the verySimpleText div.
		let NewSimpleTextDiv = document.createElement('div');
		NewSimpleTextDiv.id="verySimpleText";
		
		//let partNum = 0;
		for(var p = 0; p < episode.parts.length;p++)
		{
			let fileName = episode.parts[p];
			
			//We have to await so it doesn't load the parts in the wrong order. Which is an actual thing that has happened.
			console.log("fetching "+fileName);
			const response = await fetch("avgtxt/"+fileName);
			const out = await response.text();
			console.log("got "+fileName);
			
			//console.log(fetchTextFile("avgtxt/"+fileName));
			
			//fetch("avgtxt/"+fileName)
			//.then(response => response.text())
			//.then((out) => {
			//fetchTextFile(fileName).then(out => {
			//console.log('got '+fileName);
			let structuredLines = convertGFLTextToOpcodes(out);
			
			//console.log(structuredLines)

			//document.getElementById("DebugTextArea").value = structuredLinesToString(s)
			
			
			
			//It has underscores because it's going to be cloned
			/*let _div_ = document.createElement('div');
			_div_.className="container";
			
			let _img_ = document.createElement("img");
			_img_.src="textbox.png";
			_img_.style.width="100%";
			_div_.appendChild(_img_);
			
			let charName = document.createElement("div");
			charName.className="charName";
			_div_.appendChild(charName);
			
			let text = document.createElement("div");
			text.className="absText";
			text.id="text";
			_div_.appendChild(text);
			
			//let textboxDiv = document.getElementById("Textboxes");
			let newTextboxDiv = document.createElement('div');
			newTextboxDiv.id="Textboxes";*/
			
			let thisPartDiv = document.createElement('div');
			let h3 = document.createElement('h3');
			//console.log(partNum);
			h3.innerText="Part "+(p+1);
			//partNum++;
			thisPartDiv.appendChild(h3);
			
			let button = document.createElement('a');
			//fuck your javascript
			button.setAttribute("class","waves-effect waves-light btn");
			button.setAttribute("onclick","showOpcodes('div_"+fileName+"')")
			button.innerText="Show opcodes for this section (For debugging)"
			thisPartDiv.appendChild(button);
			thisPartDiv.appendChild(document.createElement('br'));
			
			let opcodesDiv = document.createElement('div');
			opcodesDiv.id= "div_"+fileName
			opcodesDiv.style="display: none;"
			opcodesDiv.innerHTML = "<textarea rows='6' cols='50' readonly>"+structuredLinesToString(structuredLines)+"</textarea><br>"
			thisPartDiv.appendChild(opcodesDiv)
			
			let lastSpeakerName = "";
			let lastBGUsed = ""; //'avgtexture/'+backgrounds[num]+'.png'
			let didBGOrPortraitOrNameChange = false;
			let shownPortraits = []
			
			let fancyDisplayType = document.getElementById('fancyOrNot').checked;
			
			for(var i=0;i<structuredLines.length;i++)
			{
				let opcode = structuredLines[i][0]
				//console.log(structuredLines[i]);
				switch (opcode)
				{
					case OPCODES.SPEAKER:
						lastSpeakerName=structuredLines[i][1];
						didBGOrPortraitOrNameChange = true
						break;
					case OPCODES.PORTRAIT:
						console.log(portraitStructToString(structuredLines[i]))
						let idx = structuredLines[i][1]
						let name = structuredLines[i][2]
						let type = structuredLines[i][3]
						if (PORTRAITS[name] && PORTRAITS[name][type])
						{
							//console.log(shownPortraits.length);
							if (structuredLines[i][1] > shownPortraits.length-1)
							{
								console.log("Pushed new portrait with idx "+idx);
								shownPortraits.push(structuredLines[i]);
								didBGOrPortraitOrNameChange = true;
							}
							else
							{
								let newPortrait = structuredLines[i]
								let oldPortrait = shownPortraits[idx]
								if (newPortrait[1] == oldPortrait[1] && newPortrait[2] == oldPortrait[2] && newPortrait[3] == oldPortrait[3] && newPortrait[4] == oldPortrait[4])
									console.log("New portrait set is identical to old one, ignoring change. (TODO: This should be left to the opcode interpreter to filter out!)");
								else
								{
									console.log("Portrait replaced "+portraitStructToString(oldPortrait) +" -> "+portraitStructToString(newPortrait))
									shownPortraits[idx]=newPortrait;
									didBGOrPortraitOrNameChange = true;
								}
							}
							//console.log("NumPortraits: "+shownPortraits.length);
						}
						else
						{
							consoleWarn("Portrait missing from database, ignoring.")
						}
						break;
					case OPCODES.NOPORTRAIT:
						shownPortraits = [];
						didBGOrPortraitOrNameChange = true;
						break;
					case OPCODES.BG:
						let newBG = 'avgtexture/'+backgrounds[structuredLines[i][1]]+'.png'
						if (newBG == lastBGUsed)
						{
							console.log("New BG set is identical to old one, ignoring change. (TODO: This should be left to the opcode interpreter to filter out!)");
						}
						else
						{
							console.log(lastBGUsed + " -> "+newBG)
							lastBGUsed = newBG
							didBGOrPortraitOrNameChange = true;
						}
						break;
					case OPCODES.MSG:
						//Spawn new BG with speaker and portrait here.
						if (fancyDisplayType)
						{
							//console.log("aaa");
							if (didBGOrPortraitOrNameChange)
							{
								let storyBox = document.createElement('div');
								storyBox.classList.add('storyImg');
								let bgImage = document.createElement('img');
								bgImage.style = "width:100%;position:relative;z-index:";
								bgImage.src = lastBGUsed;
								storyBox.appendChild(bgImage);
								for(var j=0;j<shownPortraits.length;j++)
								{
									console.assert(shownPortraits[j]);
									let portraitImg = document.createElement('img');
									portraitImg.src = 'pic/'+PORTRAITS[shownPortraits[j][2]][shownPortraits[j][3]];
									console.log(portraitImg.src);
									portraitImg.classList.add("storydoll");
									if (shownPortraits[j][4])
										portraitImg.classList.add('dim')
									portraitImg.classList.add(int2strPos[j+1]);
									portraitImg.classList.add(int2str[shownPortraits.length]);
									
									storyBox.appendChild(portraitImg);
								}
								thisPartDiv.appendChild(storyBox);
								
								if (lastSpeakerName != "")
								{
									let p = document.createElement('p');
									p.innerHTML = lastSpeakerName;
									//p.innerHTML = "<b>"+lastSpeakerName+"</b>";
									p.classList.add("storyText");
									p.classList.add("speakerName");
									thisPartDiv.appendChild(p);
								}
								
								didBGOrPortraitOrNameChange = false;
							}
							let p = document.createElement('p');
							p.classList.add('storyText')
							p.innerText = structuredLines[i][1];
							thisPartDiv.appendChild(p);
						}
						else
						{
							let p = document.createElement('p');
							if (lastSpeakerName == "")
								p.innerText = structuredLines[i][1];
							else
								p.innerText = lastSpeakerName + ": "+structuredLines[i][1];
							thisPartDiv.appendChild(p);
						}
						break;
					default:
						//console.log("unknown OPCODES..");
				}
			}
			NewSimpleTextDiv.appendChild(thisPartDiv);
			//Now replace the old div...
			/*let textboxDiv = document.getElementById("Textboxes");
			textboxDiv.parentNode.replaceChild(newTextboxDiv,textboxDiv);*/
			
			currentEpisodeAsOpcodes.push(structuredLines);
			
			//If phaser is already init, go ahead and set the new scene
			//...By destroying the old one and recreating it.
			if (game != undefined)
			{
				game.scene.remove('GirlsFrontlineScene');
				game.scene.add('GirlsFrontlineScene',GirlsFrontlineScene,true);
			}
			
		//})
		//})
		}
		let simpleTextDiv = document.getElementById("verySimpleText")
		simpleTextDiv.parentNode.replaceChild(NewSimpleTextDiv,simpleTextDiv);
	}
	
	function reRunWithNewOpcodes()
	{
		let lines = document.getElementById("DebugTextArea").value;
		//console.log(lines);
		let newStructuredLines = stringToStructuredLines(lines);
		console.log(newStructuredLines)
		currentEpisodeAsOpcodes[curEpisodePart] = newStructuredLines;
		if (game != undefined)
		{
			game.scene.remove('GirlsFrontlineScene');
			game.scene.add('GirlsFrontlineScene',GirlsFrontlineScene,true);
		}
	}
	
	function initPhaser()
	{
		game = new Phaser.Game(config);
		let button = document.getElementById("startButton")
		button.style.display = "none";
		document.getElementById("interactiveInterpreterSection").style.display="";
		//button.classList.add("disabled");
		//button.innerText = "started!"
		
	}
	/*function reset()
	{
		game.restart()
	}*/
	
	function showOpcodes(divId) {
		let x = document.getElementById(divId);
		if (x.style.display === "none") {
			x.style.display = "block";
		} else {
			x.style.display = "none";
		}
	}
	
	
	function getRoutableKeyString(type,chapter,episode)
	{
		return type+'-'+chapter+'-'+episode
	}
	function getKeysFromRoutableString(s)
	{
		return s.split('-');
	}
	
	function onChapterSelected(value)
	{
		console.log(value);
		let [type,chapter,episode] = getKeysFromRoutableString(value)
		runFromRoutableKeyString(value)
		if (game == undefined)
			document.getElementById("startButton").classList.remove('disabled');
	}
	function goToNextEpisode()
	{
		let value = curEpKey;
		console.log(value);
		let [type,chapter,episode] = getKeysFromRoutableString(value)
		episode++;
		if (listOfChapters[type][chapter]['episodes'][episode])
		{
			runFromRoutableKeyString(getRoutableKeyString(type,chapter,episode))
			return true;
		}
		else
		{
			chapter++;
			episode = 0;
		}
		
		if (listOfChapters[type][chapter]['episodes'][episode])
		{
			runFromRoutableKeyString(getRoutableKeyString(type,chapter,episode))
			return true;
		}
		
		return false;
	}
	
	function appendFromij(i,j,name,letter)
	{
		return {
			name:  name+' '+i+'-'+j,
			parts: [i+'-'+j+'-1'+letter+'.txt',
					i+'-'+j+'-2'+letter+'.txt'],
		}
	}
	
	//I finally used a class, aren't you happy? 
	class FilterableList {
		constructor(data,keyToSearch,idToBind) {
			console.assert(data,"FilterableList: Data undefined!")
			this.data = data;
			this.fuse = new Fuse(data, {
				keys: [keyToSearch]
			})
			this.elementId = idToBind
			
			let el = document.getElementById(idToBind);
			el.innerHTML = "" //You shouldn't have anything in here in the first place
			
			
			let div = document.createElement('div');
			div.id = idToBind+'SearchDiv';
				let form = document.createElement('form');
				form.action = "?";
					let inputField = document.createElement('div');
					inputField.classList.add('input-field');
					inputField.style="text-align: left;";
						let i = document.createElement('i');
						i.classList.add("material-icons");
						i.classList.add('prefix');
						i.innerText="search";
						
						
						let input = document.createElement('input');
						input
						//input.onchange = function(ev) { console.log(ev); this.search(this) }
						input.setAttribute('onkeydown',"if (event.key == 'Enter') blur(); return;");
						input.addEventListener('change',this.search.bind(this) );
						input.id=idToBind+'search'
						input.type='search';
						input.onsubmit="blur()"
						input.required=true
						
					inputField.appendChild(i);
					inputField.appendChild(input);
					
				form.appendChild(inputField);
			div.appendChild(form);
			
			
			//Don't bother, none of it works anyways
			/*let inputFromDOM = document.getElementById(idToBind+'search');
			input.addEventListener('onkeyup',function() { console.log("aa") } );
			input.addEventListener('onkeydown',function() {if (event.key == 'Enter') blur(); return;})*/
			/*<form action="?">
				<div class="input-field" style="text-align: left;">
					<i class="material-icons prefix">search</i>
					<!--<label class="label-icon" for="search">
					</label>-->
					<input id="search" type="search" oninput="searchDolls(document.getElementById('search').value)" onkeydown="if (event.key == 'Enter') blur(); return;" onsubmit="blur()" required>
					
					<i class="material-icons" onclick="clearSearch()">close</i>
				</div>
			</form>*/
			
			el.appendChild(div);
			
			this.collection = document.createElement('div');
			this.collection.classList.add('collection');
			//this._li_=document.createElement('li');
			this._li_=document.createElement('a');
			this._li_.href="#theTop";
			this._li_.classList.add('collection-item');
			/*this._li_.classList.add('waves-effect');
			this._li_.classList.add('waves-light');
			this._li_.style="cursor:pointer;";*/
			
			el.appendChild(this.collection);
			
			this.generateResults(this.data);
		}
		
		//It's just like lua Kappa
		search()
		{
			console.assert(this)
			let query = document.getElementById(this.elementId+'search').value
			console.log(query);
			clearTimeout(this.delayTimer);
			this.delayTimer = setTimeout(function() {
				
				if (query == "" || query == undefined)
				{
					this.generateResults(this.data);
				}
				else
				{
					
					/*query = query.toLowerCase();
					console.log("Searching for "+query);*/
					
					var results = this.fuse.search(query);
					console.log("Got "+results.length + " results");
					//I don't care if it's slow
					this.generateResults(Array.from(results, r => r['item']));
				}
			}.bind(this), 300);
		}
		
		generateResults(results)
		{
			console.log(results);
			this.collection.innerHTML="";
			for (var i = 0; i < results.length; i++)
			{
				let li = this._li_.cloneNode(true);
				li.innerText=results[i]['name'];
				this.collection.appendChild(li);
			}
		}
		
	}
	
	//name field is structured like type-chapter-episode
	listOfChapters={
		'main':[],
		'event':[],
		'side':[], //also skin
		'crossover':[]
	}
	function generateTables() {
		
		//Special for chapter 0
		{
			let chapterZero = []
			for(j=1;j<5;j++)
			{
				chapterZero.push(appendFromij(0,j,"Normal",''))
			}
			listOfChapters['main'].push({name:"Chapter 0",episodes:chapterZero});
		}
		//Normal chapters
		for(i=1;i<13;i++)
		{
			let curChapter = []
			for(j=1;j<=6;j++)
			{
				curChapter.push(appendFromij(i,j,"Normal",''))
			}
			for(j=1;j<=4;j++)
			{
				curChapter.push(appendFromij(i,j,"Emergency",'E'))
			}
			for(j=1;j<=4;j++)
			{
				curChapter.push(appendFromij(i,j,"Midnight",'N'))
			}
			listOfChapters['main'].push({name:'Chapter '+i,episodes:curChapter});
			
			//What am I supposed to do?
			/*if (i==5)
			{
				listOfChapters.push({
					name:"Operation Cube",
					episodes:[
						{name:"Seven Step Puzzle",begin:,mid:end:},
					]
				})
			}*/
		}
		
		//Events
		let prologue = []
		for(i=0;i<12;i++)
		{
			prologue.push({name:"Start"+i,parts:['startavg/Start'+i+".txt"]});
		}
		listOfChapters['event'].push({name:"Prologue",episodes:prologue});
		
		//Yep. Here we are.
		listOfChapters['event'].push({
			"name": "CH. 5.5: Operation Cube",
			"episodes": [
				{
					"name": "-1-1",
					"parts": [
						"-1-1-1.txt",
						"-1-1-2.txt"
					]
				},
				{
					"name": "-1-2",
					"parts": [
						"-1-2-1.txt",
						"-1-2-2End.txt",
						"-1-2-2First.txt"
					]
				},
				{
					"name": "-1-3",
					"parts": [
						"-1-3-1.txt",
						"-1-3-2End.txt",
						"-1-3-2First.txt"
					]
				},
				{
					"name": "-1-4",
					"parts": [
						"-1-4-1.txt",
						"-1-4-2End.txt",
						"-1-4-2First.txt"
					]
				}
			]
		})
		listOfChapters['event'].push({
			"name": "CH. 7.5: Arctic Warfare",
			"episodes": [
				{
					"name": "-2-1",
					"parts": [
						"-2-1-4-Point2179.txt",
						"-2-1-1.txt",
						"-2-1-2First.txt",
						"-2-1-4-Point2007.txt",
						"-2-1-4-Point2207.txt"
					]
				},
				{
					"name": "-2-2",
					"parts": [
						"-2-2-1.txt",
						"-2-2-2First.txt",
						"-2-2-4-Point2204.txt"
					]
				},
				{
					"name": "-2-3",
					"parts": [
						"-2-3-1.txt",
						"-2-3-2First.txt",
						"-2-3-4-Point2058.txt",
						"-2-3-4-Point2215.txt"
					]
				},
				{
					"name": "-2-4",
					"parts": [
						"-2-4-1.txt",
						"-2-4-2End.txt",
						"-2-4-2First.txt"
					]
				},
				{
					"name": "-3-1",
					"parts": [
						"-3-1-1.txt",
						"-3-1-2First.txt"
					]
				},
				{
					"name": "-3-2",
					"parts": [
						"-3-2-1.txt",
						"-3-2-2First.txt"
					]
				},
				{
					"name": "-3-3",
					"parts": [
						"-3-3-1.txt",
						"-3-3-2First.txt"
					]
				},
				{
					"name": "-3-4",
					"parts": [
						"-3-4-1.txt",
						"-3-4-2End.txt",
						"-3-4-2First.txt",
						"-3-4-4-Point2499.txt"
					]
				},
				{
					"name": "-4-1",
					"parts": [
						"-4-1-1.txt",
						"-4-1-2First.txt"
					]
				},
				{
					"name": "-4-2",
					"parts": [
						"-4-2-1.txt",
						"-4-2-2First.txt"
					]
				},
				{
					"name": "-4-3",
					"parts": [
						"-4-3-2First.txt",
						"-4-3-1.txt"
					]
				},
				{
					"name": "-4-4",
					"parts": [
						"-4-4-1.txt",
						"-4-4-2End.txt",
						"-4-4-2First.txt"
					]
				},
				{
					"name": "-5-1",
					"parts": [
						"-5-1-1.txt",
						"-5-1-3Round10.txt"
					]
				}
			]
		})
		listOfChapters['event'].push({
			"name": "CH. 7.75: Operation Cube+",
			"episodes": [
				{
					"name": "-7-1",
					"parts": [
						"-7-1-1.txt",
						"-7-1-2End.txt",
						"-7-1-2First.txt",
						"-7-1-3Round2.txt",
						"-7-1-4-Point3498.txt",
						"-7-1-3Round1.txt"
					]
				},
				{
					"name": "-7-2",
					"parts": [
						"-7-2-1.txt",
						"-7-2-2End.txt",
						"-7-2-2First.txt",
						"-7-2-3Round1.txt",
						"-7-2-3Round2.txt",
						"-7-2-4-Point3342.txt"
					]
				},
				{
					"name": "-7-3",
					"parts": [
						"-7-3-1.txt",
						"-7-3-2End.txt",
						"-7-3-2First.txt",
						"-7-3-3Round1.txt",
						"-7-3-3Round2.txt",
						"-7-3-4-Point3533.txt"
					]
				},
				{
					"name": "-7-4",
					"parts": [
						"-7-4-1.txt",
						"-7-4-2End.txt",
						"-7-4-2First.txt",
						"-7-4-3Round1.txt",
						"-7-4-3Round2.txt",
						"-7-4-4-Point3612.txt"
					]
				}
			]
		})
		listOfChapters['event'].push({
			"name": "CH. 8.5: Deep Dive",
			"episodes": [
				{
					"name": "-10-1",
					"parts": [
						"-10-1-1.txt",
						"-10-1-2First.txt"
					]
				},
				{
					"name": "-10-2",
					"parts": [
						"-10-2-1.txt",
						"-10-2-2First.txt"
					]
				},
				{
					"name": "-10-3",
					"parts": [
						"-10-3-1.txt",
						"-10-3-2First.txt",
						"-10-3-4-Point4229.txt"
					]
				},
				{
					"name": "-10-4",
					"parts": [
						"-10-4-1.txt",
						"-10-4-2End.txt",
						"-10-4-2First.txt"
					]
				},
				{
					"name": "-11-1",
					"parts": [
						"-11-1-1.txt",
						"-11-1-2First.txt",
						"-11-1-4-Point4270.txt"
					]
				},
				{
					"name": "-11-2",
					"parts": [
						"-11-2-1.txt",
						"-11-2-2First.txt",
						"-11-2-4-Point4292.txt"
					]
				},
				{
					"name": "-11-3",
					"parts": [
						"-11-3-1.txt",
						"-11-3-2First.txt",
						"-11-3-4-Point4411.txt"
					]
				},
				{
					"name": "-11-4",
					"parts": [
						"-11-4-1.txt",
						"-11-4-2End.txt",
						"-11-4-2First.txt",
						"-11-4-4-Point4431.txt"
					]
				},
				{
					"name": "-12-1",
					"parts": [
						"-12-1-1.txt",
						"-12-1-2First.txt",
						"-12-1-4-Point4528.txt",
						"-12-1-4-Point4538.txt",
						"-12-1-4-Point4540.txt"
					]
				},
				{
					"name": "-12-2",
					"parts": [
						"-12-2-2First.txt",
						"-12-2-4-Point4560.txt",
						"-12-2-4-Point4562.txt",
						"-12-2-4-Point4601.txt",
						"-12-2-1.txt"
					]
				},
				{
					"name": "-12-3",
					"parts": [
						"-12-3-1.txt",
						"-12-3-2First.txt",
						"-12-3-4-Point4605.txt",
						"-12-3-4-Point4615.txt",
						"-12-3-4-Point4641.txt"
					]
				},
				{
					"name": "-12-4",
					"parts": [
						"-12-4-1.txt",
						"-12-4-2End.txt",
						"-12-4-2First.txt",
						"-12-4-4-Point4518.txt",
						"-12-4-4-Point4671.txt",
						"-12-4-4-Point4723.txt",
						"-12-4-4-Point4724.txt"
					]
				},
				{
					"name": "-13-1",
					"parts": [
						"-13-1-1.txt"
					]
				}
			]
		})
		listOfChapters['event'].push({
			"name": "CH. 10.5: Singularity",
			"episodes": [
				{
					"name": "-16-1",
					"parts": [
						"-16-10-1.txt",
						"-16-11-2First.txt",
						"-16-12-2First.txt",
						"-16-13-2First.txt",
						"-16-14-2First.txt",
						"-16-15-2First.txt",
						"-16-16-1.txt"
					]
				},
				{
					"name": "-16-2",
					"parts": [
						"-16-2-1.txt"
					]
				},
				{
					"name": "-16-3",
					"parts": [
						"-16-3-1.txt"
					]
				},
				{
					"name": "-16-4",
					"parts": [
						"-16-4-1.txt",
						"-16-4-2First.txt",
						"-16-4-4-Point5546.txt"
					]
				},
				{
					"name": "-16-5",
					"parts": [
						"-16-5-2First.txt"
					]
				},
				{
					"name": "-16-6",
					"parts": [
						"-16-6-2First.txt"
					]
				},
				{
					"name": "-16-7",
					"parts": [
						"-16-7-2First.txt"
					]
				},
				{
					"name": "-16-8",
					"parts": [
						"-16-8-2First.txt",
						"-16-8-4-Point5627.txt"
					]
				},
				{
					"name": "-16-9",
					"parts": [
						"-16-9-2First.txt"
					]
				},
				{
					"name": "-16-10",
					"parts": [
						"-16-10-1.txt"
					]
				},
				{
					"name": "-16-11",
					"parts": [
						"-16-11-2First.txt"
					]
				},
				{
					"name": "-16-12",
					"parts": [
						"-16-12-2First.txt"
					]
				},
				{
					"name": "-16-13",
					"parts": [
						"-16-13-2First.txt"
					]
				},
				{
					"name": "-16-14",
					"parts": [
						"-16-14-2First.txt"
					]
				},
				{
					"name": "-16-15",
					"parts": [
						"-16-15-2First.txt"
					]
				},
				{
					"name": "-16-16",
					"parts": [
						"-16-16-1.txt"
					]
				},
				{
					"name": "-17-1",
					"parts": [
						"-17-10-1.txt",
						"-17-1-1.txt",
						"-17-1-2First.txt",
						"-17-11-1.txt",
						"-17-11-2First.txt",
						"-17-12-2First.txt",
						"-17-13-1.txt",
						"-17-13-2First.txt",
						"-17-14-1.txt",
						"-17-14-2First.txt",
						"-17-15-1.txt",
						"-17-15-2First.txt",
						"-17-16-1.txt",
						"-17-16-2First.txt",
						"-17-17-1.txt",
						"-17-17-2First.txt",
						"-17-18-1.txt"
					]
				},
				{
					"name": "-17-2",
					"parts": [
						"-17-2-1.txt",
						"-17-2-2First.txt"
					]
				},
				{
					"name": "-17-3",
					"parts": [
						"-17-3-1.txt",
						"-17-3-2First.txt"
					]
				},
				{
					"name": "-17-4",
					"parts": [
						"-17-4-2First.txt",
						"-17-4-1.txt"
					]
				},
				{
					"name": "-17-5",
					"parts": [
						"-17-5-2First.txt"
					]
				},
				{
					"name": "-17-6",
					"parts": [
						"-17-6-2First.txt"
					]
				},
				{
					"name": "-17-7",
					"parts": [
						"-17-7-2First.txt"
					]
				},
				{
					"name": "-17-8",
					"parts": [
						"-17-8-2First.txt"
					]
				},
				{
					"name": "-17-9",
					"parts": [
						"-17-9-2First.txt"
					]
				},
				{
					"name": "-17-10",
					"parts": [
						"-17-10-1.txt"
					]
				},
				{
					"name": "-17-11",
					"parts": [
						"-17-11-1.txt",
						"-17-11-2First.txt"
					]
				},
				{
					"name": "-17-12",
					"parts": [
						"-17-12-2First.txt"
					]
				},
				{
					"name": "-17-13",
					"parts": [
						"-17-13-1.txt",
						"-17-13-2First.txt"
					]
				},
				{
					"name": "-17-14",
					"parts": [
						"-17-14-1.txt",
						"-17-14-2First.txt"
					]
				},
				{
					"name": "-17-15",
					"parts": [
						"-17-15-1.txt",
						"-17-15-2First.txt"
					]
				},
				{
					"name": "-17-16",
					"parts": [
						"-17-16-1.txt",
						"-17-16-2First.txt"
					]
				},
				{
					"name": "-17-17",
					"parts": [
						"-17-17-1.txt",
						"-17-17-2First.txt"
					]
				},
				{
					"name": "-17-18",
					"parts": [
						"-17-18-1.txt"
					]
				},
				{
					"name": "-18-1",
					"parts": [
						"-18-1-1.txt",
						"-18-1-2First.txt"
					]
				},
				{
					"name": "-18-2",
					"parts": [
						"-18-2-1.txt",
						"-18-2-2First.txt",
						"-18-2-4-Point6188.txt"
					]
				},
				{
					"name": "-18-3",
					"parts": [
						"-18-3-1.txt",
						"-18-3-2First.txt"
					]
				},
				{
					"name": "-18-4",
					"parts": [
						"-18-4-1.txt",
						"-18-4-2First.txt"
					]
				},
				{
					"name": "-18-5",
					"parts": [
						"-18-5-1.txt",
						"-18-5-2First.txt",
						"-18-5-4-Point6303.txt"
					]
				},
				{
					"name": "-18-6",
					"parts": [
						"-18-6-1.txt",
						"-18-6-2First.txt"
					]
				},
				{
					"name": "-18-7",
					"parts": [
						"-18-7-1.txt"
					]
				},
				{
					"name": "-18-8",
					"parts": [
						"-18-8-1.txt"
					]
				}
			]
		})
		listOfChapters['event'].push({
			"name": "Ch. 10.75: Continuum Turbulence",
			"episodes": [
				{
					"name": "Waste",
					"parts": [
						"-24-2-1.txt",
						"-24-2-2.txt"
					]
				},
				{
					"name": "-24-1",
					"parts": [
						"-24-13-2First.txt",
						"-24-1-1.txt",
						"-24-1-2First.txt",
						"-24-10-1.txt",
						"-24-10-2.txt",
						"-24-10-2First.txt",
						"-24-11-1.txt",
						"-24-11-2.txt",
						"-24-11-2First.txt",
						"-24-12-1.txt",
						"-24-12-2.txt",
						"-24-12-2First.txt",
						"-24-13-1.txt",
						"-24-13-2.txt",
						"-24-14-1.txt",
						"-24-14-2.txt",
						"-24-14-2First.txt",
						"-24-15-1.txt",
						"-24-15-2.txt",
						"-24-15-2First.txt"
					]
				},
				{
					"name": "-24-3",
					"parts": [
						"-24-3-2.txt",
						"-24-3-2First.txt"
					]
				},
				{
					"name": "-24-4",
					"parts": [
						"-24-4-1.txt",
						"-24-4-2.txt",
						"-24-4-2First.txt"
					]
				},
				{
					"name": "-24-5",
					"parts": [
						"-24-5-1.txt",
						"-24-5-2First.txt"
					]
				},
				{
					"name": "-24-6",
					"parts": [
						"-24-6-1.txt",
						"-24-6-2.txt"
					]
				},
				{
					"name": "-24-7",
					"parts": [
						"-24-7-1.txt",
						"-24-7-2.txt",
						"-24-7-2First.txt"
					]
				},
				{
					"name": "-24-8",
					"parts": [
						"-24-8-1.txt",
						"-24-8-2.txt",
						"-24-8-2First.txt"
					]
				},
				{
					"name": "-24-9",
					"parts": [
						"-24-9-2.txt",
						"-24-9-2First.txt"
					]
				},
				{
					"name": "-24-10",
					"parts": [
						"-24-10-1.txt",
						"-24-10-2.txt",
						"-24-10-2First.txt"
					]
				},
				{
					"name": "-24-11",
					"parts": [
						"-24-11-1.txt",
						"-24-11-2.txt",
						"-24-11-2First.txt"
					]
				},
				{
					"name": "-24-12",
					"parts": [
						"-24-12-1.txt",
						"-24-12-2.txt",
						"-24-12-2First.txt"
					]
				},
				{
					"name": "-24-13",
					"parts": [
						"-24-13-2First.txt",
						"-24-13-1.txt",
						"-24-13-2.txt"
					]
				},
				{
					"name": "-24-14",
					"parts": [
						"-24-14-1.txt",
						"-24-14-2.txt",
						"-24-14-2First.txt"
					]
				},
				{
					"name": "-24-15",
					"parts": [
						"-24-15-1.txt",
						"-24-15-2.txt",
						"-24-15-2First.txt"
					]
				},
				{
					"name": "-25-1",
					"parts": [
						"-25-1-1.txt",
						"-25-1-2First.txt",
						"-25-10-1.txt",
						"-25-10-2First.txt",
						"-25-11-1.txt",
						"-25-12-2First.txt",
						"-25-13-2First.txt",
						"-25-14-2First.txt",
						"-25-15-2First.txt",
						"-25-16-2First.txt"
					]
				},
				{
					"name": "-25-2",
					"parts": [
						"-25-2-1.txt"
					]
				},
				{
					"name": "-25-3",
					"parts": [
						"-25-3-2First.txt",
						"-25-3-1.txt"
					]
				},
				{
					"name": "-25-4",
					"parts": [
						"-25-4-1.txt"
					]
				},
				{
					"name": "-25-5",
					"parts": [
						"-25-5-1.txt"
					]
				},
				{
					"name": "-25-6",
					"parts": [
						"-25-6-1.txt"
					]
				},
				{
					"name": "-25-7",
					"parts": [
						"-25-7-1.txt"
					]
				},
				{
					"name": "-25-8",
					"parts": [
						"-25-8-1.txt",
						"-25-8-2First.txt"
					]
				},
				{
					"name": "-25-9",
					"parts": [
						"-25-9-1.txt",
						"-25-9-2First.txt"
					]
				},
				{
					"name": "-25-10",
					"parts": [
						"-25-10-1.txt",
						"-25-10-2First.txt"
					]
				},
				{
					"name": "-25-11",
					"parts": [
						"-25-11-1.txt"
					]
				},
				{
					"name": "-25-12",
					"parts": [
						"-25-12-2First.txt"
					]
				},
				{
					"name": "-25-13",
					"parts": [
						"-25-13-2First.txt"
					]
				},
				{
					"name": "-25-14",
					"parts": [
						"-25-14-2First.txt"
					]
				},
				{
					"name": "-25-15",
					"parts": [
						"-25-15-2First.txt"
					]
				},
				{
					"name": "-25-16",
					"parts": [
						"-25-16-2First.txt"
					]
				},
				{
					"name": "-26-1",
					"parts": [
						"-26-15-2First.txt",
						"-26-1-1.txt",
						"-26-1-2First.txt",
						"-26-10-2First.txt",
						"-26-11-1.txt",
						"-26-11-2First.txt",
						"-26-12-1.txt",
						"-26-13-1.txt",
						"-26-13-2First.txt",
						"-26-14-1.txt",
						"-26-14-2End.txt",
						"-26-14-2First.txt",
						"-26-18-2First.txt"
					]
				},
				{
					"name": "-26-2",
					"parts": [
						"-26-2-1.txt"
					]
				},
				{
					"name": "-26-3",
					"parts": [
						"-26-3-1.txt"
					]
				},
				{
					"name": "-26-4",
					"parts": [
						"-26-4-1.txt"
					]
				},
				{
					"name": "-26-5",
					"parts": [
						"-26-5-1.txt",
						"-26-5-2First.txt"
					]
				},
				{
					"name": "-26-6",
					"parts": [
						"-26-6-1.txt",
						"-26-6-2First.txt"
					]
				},
				{
					"name": "-26-7",
					"parts": [
						"-26-7-1.txt"
					]
				},
				{
					"name": "-26-8",
					"parts": [
						"-26-8-2First.txt"
					]
				},
				{
					"name": "-26-9",
					"parts": [
						"-26-9-1.txt"
					]
				},
				{
					"name": "-26-10",
					"parts": [
						"-26-10-2First.txt"
					]
				},
				{
					"name": "-26-11",
					"parts": [
						"-26-11-1.txt",
						"-26-11-2First.txt"
					]
				},
				{
					"name": "-26-12",
					"parts": [
						"-26-12-1.txt"
					]
				},
				{
					"name": "-26-13",
					"parts": [
						"-26-13-1.txt",
						"-26-13-2First.txt"
					]
				},
				{
					"name": "-26-14",
					"parts": [
						"-26-14-1.txt",
						"-26-14-2End.txt",
						"-26-14-2First.txt"
					]
				},
				{
					"name": "-26-15",
					"parts": [
						"-26-15-2First.txt"
					]
				},
				{
					"name": "-28-1",
					"parts": [
						"-28-1-1.txt"
					]
				}
			]
		})
		
		listOfChapters['side'].push({name:"Skin Stories",episodes:[
	{
		"name": "Makarov - Pumpkin Mishka",
		"parts": [
			"skin/1.txt"
		]
	},
	{
		"name": "Type 64 - Witch from Afar",
		"parts": [
			"skin/11.txt"
		]
	},
	{
		"name": "Thompson - Demon Hunter",
		"parts": [
			"skin/1501.txt"
		]
	},
	{
		"name": "Contender - Opera Ghost",
		"parts": [
			"skin/1502.txt"
		]
	},
	{
		"name": "PKP - L.A.D.Y",
		"parts": [
			"skin/1503.txt"
		]
	},
	{
		"name": "MG5 - Call of the Hunter",
		"parts": [
			"skin/1504.txt"
		]
	},
	{
		"name": "AEK-999 - Babe Driver",
		"parts": [
			"skin/1505.txt"
		]
	},
	{
		"name": "PzB 39 - Raging Rider",
		"parts": [
			"skin/1506.txt"
		]
	},
	{
		"name": "G36 - \"Sommelier\"",
		"parts": [
			"skin/1507.txt"
		]
	},
	{
		"name": "DSR-50 - Red Peony",
		"parts": [
			"skin/1801.txt"
		]
	},
	{
		"name": "S.A.T.8 - Wintersweet",
		"parts": [
			"skin/1802.txt"
		]
	},
	{
		"name": "ART556 - White Cabbage",
		"parts": [
			"skin/1803.txt"
		]
	},
	{
		"name": "JS05 - Fairy Lily",
		"parts": [
			"skin/1804.txt"
		]
	},
	{
		"name": "Mk23 - Honey Flower",
		"parts": [
			"skin/1805.txt"
		]
	},
	{
		"name": "M590 - Angel's Trumpet",
		"parts": [
			"skin/1806.txt"
		]
	},
	{
		"name": "Type 81 Carbine - White Camellia",
		"parts": [
			"skin/1807.txt"
		]
	},
	{
		"name": "LWMMG - Golden Starthistle",
		"parts": [
			"skin/1808.txt"
		]
	},
	{
		"name": "Vector - Ardent Devotion",
		"parts": [
			"skin/1901.txt"
		]
	},
	{
		"name": "Five-seveN - Smile of Acceptance",
		"parts": [
			"skin/1902.txt"
		]
	},
	{
		"name": "G36 - Pure White Cornflower",
		"parts": [
			"skin/1904.txt"
		]
	},
	{
		"name": "Type 56-1 - As One, Forever Entwined",
		"parts": [
			"skin/1905.txt"
		]
	},
	{
		"name": "SV-98 - Pierce Your Heart!",
		"parts": [
			"skin/1906.txt"
		]
	},
	{
		"name": "AK-47 - Kitty Paws",
		"parts": [
			"skin/2.txt"
		]
	},
	{
		"name": "PP-90 - Kitty Paws",
		"parts": [
			"skin/2.txt"
		]
	},
	{
		"name": "Vector - Kitty Paws",
		"parts": [
			"skin/2.txt"
		]
	},
	{
		"name": "DSR-50 - Highest Bid",
		"parts": [
			"skin/2101.txt"
		]
	},
	{
		"name": "Grizzly MkV - Starry Night Ball",
		"parts": [
			"skin/2102.txt"
		]
	},
	{
		"name": "Welrod MkII - Nightfall Crisis",
		"parts": [
			"skin/2103.txt"
		]
	},
	{
		"name": "Zas M21 - White Queen",
		"parts": [
			"skin/2104.txt"
		]
	},
	{
		"name": "Colt Revolver - Queen of Miracles",
		"parts": [
			"skin/2105.txt"
		]
	},
	{
		"name": "UMP9 - The World's Melody",
		"parts": [
			"skin/2106.txt"
		]
	},
	{
		"name": "UMP45 - Flower of Diamond",
		"parts": [
			"skin/2107.txt"
		]
	},
	{
		"name": "IDW - Cat in the Box",
		"parts": [
			"skin/2108.txt"
		]
	},
	{
		"name": "EVO 3 - White Night Star",
		"parts": [
			"skin/2109.txt"
		]
	},
	{
		"name": "NTW-20 - The Aristocrat Experience",
		"parts": [
			"skin/2301.txt"
		]
	},
	{
		"name": "Contender - Flowerful Maid",
		"parts": [
			"skin/2302.txt"
		]
	},
	{
		"name": "M950A - Home Ec Training",
		"parts": [
			"skin/2303.txt"
		]
	},
	{
		"name": "G28 - Wiesnbier",
		"parts": [
			"skin/2304.txt"
		]
	},
	{
		"name": "Gepard M1 - Contracted Today",
		"parts": [
			"skin/2305.txt"
		]
	},
	{
		"name": "G41 - Beach Punk 2064",
		"parts": [
			"skin/2401.txt"
		]
	},
	{
		"name": "AA-12 - The Sun Never Rises",
		"parts": [
			"skin/2403.txt"
		]
	},
	{
		"name": "AN-94 - The Diving Bell and the Doll",
		"parts": [
			"skin/2404.txt"
		]
	},
	{
		"name": "MP7 - Lollipop Ammo",
		"parts": [
			"skin/2405.txt"
		]
	},
	{
		"name": "FAL - FAL's Summer",
		"parts": [
			"skin/2406.txt"
		]
	},
	{
		"name": "G36 - 50 Days with Gr G36",
		"parts": [
			"skin/2407.txt"
		]
	},
	{
		"name": "SPAS-12 - Midsummer Fruit",
		"parts": [
			"skin/2408.txt"
		]
	},
	{
		"name": "Ameli - Ameli's Receive",
		"parts": [
			"skin/2409.txt"
		]
	},
	{
		"name": "P38 - Apprentice Witch",
		"parts": [
			"skin/2410.txt"
		]
	},
	{
		"name": "S.A.T.8 - Pumpkin Skewers",
		"parts": [
			"skin/2601.txt"
		]
	},
	{
		"name": "TAC-50 - Elf Helsing",
		"parts": [
			"skin/2602.txt"
		]
	},
	{
		"name": "MDR - Ghost Trap",
		"parts": [
			"skin/2603.txt"
		]
	},
	{
		"name": "FAMAS - Guns N' Side Boxes",
		"parts": [
			"skin/2604.txt"
		]
	},
	{
		"name": "Bren - Jack the Trine",
		"parts": [
			"skin/2605.txt"
		]
	},
	{
		"name": "F1 - Dark Sorceress Academy",
		"parts": [
			"skin/2606.txt"
		]
	},
	{
		"name": "Px4 Storm - Queen of X'mas Morning",
		"parts": [
			"skin/2801.txt"
		]
	},
	{
		"name": "P90 - Scarlet Turbo",
		"parts": [
			"skin/2802.txt"
		]
	},
	{
		"name": "ART556 - Little Chimney Sweeper",
		"parts": [
			"skin/2803.txt"
		]
	},
	{
		"name": "FP-6 - Satellite of Love",
		"parts": [
			"skin/2804.txt"
		]
	},
	{
		"name": "Five-seveN - Blue Christmas",
		"parts": [
			"skin/2805.txt"
		]
	},
	{
		"name": "TMP - Red-Eared Cat",
		"parts": [
			"skin/2807.txt"
		]
	},
	{
		"name": "MP5 - Nocturnal Familiar",
		"parts": [
			"skin/3.txt"
		]
	},
	{
		"name": "OTs-14 - Crassula Volkensii",
		"parts": [
			"skin/3001.txt"
		]
	},
	{
		"name": "AK-74U - Lily of the Valley",
		"parts": [
			"skin/3002.txt"
		]
	},
	{
		"name": "Type 88 - Noble Orchid",
		"parts": [
			"skin/3003.txt"
		]
	},
	{
		"name": "IWS 2000 - Edelweiss",
		"parts": [
			"skin/3004.txt"
		]
	},
	{
		"name": "CZ75 - Monks Cress",
		"parts": [
			"skin/3005.txt"
		]
	},
	{
		"name": "MP5 - Vietnamese Balm",
		"parts": [
			"skin/3006.txt"
		]
	},
	{
		"name": "CZ52 - Tweedia",
		"parts": [
			"skin/3007.txt"
		]
	},
	{
		"name": "Colt Revolver - Wish Upon A Star",
		"parts": [
			"skin/301.txt"
		]
	},
	{
		"name": "Springfield - O Holy Night",
		"parts": [
			"skin/302.txt"
		]
	},
	{
		"name": "M14 - Xmas Parade",
		"parts": [
			"skin/303.txt"
		]
	},
	{
		"name": "M21 - Xmas At Home",
		"parts": [
			"skin/304.txt"
		]
	},
	{
		"name": "SVD - Winter Fairy",
		"parts": [
			"skin/305.txt"
		]
	},
	{
		"name": "WA2000 - Date in the Snow",
		"parts": [
			"skin/306.txt"
		]
	},
	{
		"name": "NTW-20 - Xmas Reindeer",
		"parts": [
			"skin/307.txt"
		]
	},
	{
		"name": "FAL - Winter Supply",
		"parts": [
			"skin/308.txt"
		]
	},
	{
		"name": "MG5 - Crimson Guardian",
		"parts": [
			"skin/309.txt"
		]
	},
	{
		"name": "Suomi - Korvatunturi Pixie",
		"parts": [
			"skin/310.txt"
		]
	},
	{
		"name": "PKP - Silver Star",
		"parts": [
			"skin/3102.txt"
		]
	},
	{
		"name": "G36C - You Who Steps Up",
		"parts": [
			"skin/3103.txt"
		]
	},
	{
		"name": "Mk23 - Conveyed Feelings",
		"parts": [
			"skin/3105.txt"
		]
	},
	{
		"name": "T-5000 - Oath of Transformation",
		"parts": [
			"skin/3106.txt"
		]
	},
	{
		"name": "Gepard M1 - Exciting Future",
		"parts": [
			"skin/3107.txt"
		]
	},
	{
		"name": "K2 - Before Dawn",
		"parts": [
			"skin/3301.txt"
		]
	},
	{
		"name": "AK-12 - Untranslated1",
		"parts": [
			"skin/3302.txt"
		]
	},
	{
		"name": "AN-94 - Untranslated1",
		"parts": [
			"skin/3303.txt"
		]
	},
	{
		"name": "M99 - Untranslated1",
		"parts": [
			"skin/3304.txt"
		]
	},
	{
		"name": "MDR - Untranslated1",
		"parts": [
			"skin/3305.txt"
		]
	},
	{
		"name": "Type 79 - Untranslated1",
		"parts": [
			"skin/3306.txt"
		]
	},
	{
		"name": "G28 - Untranslated1",
		"parts": [
			"skin/3307.txt"
		]
	},
	{
		"name": "K5 - Untranslated1",
		"parts": [
			"skin/3308.txt"
		]
	},
	{
		"name": "Thunder - Untranslated1",
		"parts": [
			"skin/3309.txt"
		]
	},
	{
		"name": "R93 - Untranslated1",
		"parts": [
			"skin/3501.txt"
		]
	},
	{
		"name": "Lewis - Untranslated2",
		"parts": [
			"skin/3502.txt"
		]
	},
	{
		"name": "C-MS - Untranslated1",
		"parts": [
			"skin/3503.txt"
		]
	},
	{
		"name": "Type 88 - Untranslated1",
		"parts": [
			"skin/3504.txt"
		]
	},
	{
		"name": "Type 4 - Untranslated2",
		"parts": [
			"skin/3505.txt"
		]
	},
	{
		"name": "MP5 - A Small Step",
		"parts": [
			"skin/1903.txt"
		]
	},
	{
		"name": "AK-12 - Age of Slushies",
		"parts": [
			"skin/2402.txt"
		]
	},
	{
		"name": "G36 - Every Child's X'mas Dream",
		"parts": [
			"skin/2806.txt"
		]
	},
	{
		"name": "Suomi - Blissful Mission",
		"parts": [
			"skin/3101.txt"
		]
	},
	{
		"name": "Serdyukov - Untranslated1",
		"parts": [
			"skin/3506.txt"
		]
	},
	{
		"name": "PKP - Untranslated1",
		"parts": [
			"skin/4203.txt"
		]
	},
	{
		"name": "Z-62 - Untranslated1",
		"parts": [
			"skin/3507.txt"
		]
	},
	{
		"name": "QBU-88 - Untranslated1",
		"parts": [
			"skin/3801.txt"
		]
	},
	{
		"name": "G36C - Untranslated1",
		"parts": [
			"skin/3802.txt"
		]
	},
	{
		"name": "M870 - Untranslated1",
		"parts": [
			"skin/3803.txt"
		]
	},
	{
		"name": "KSVK - Untranslated1",
		"parts": [
			"skin/3805.txt"
		]
	},
	{
		"name": "MG3 - Untranslated2",
		"parts": [
			"skin/3806.txt"
		]
	},
	{
		"name": "Type 97 Shotgun - Untranslated1",
		"parts": [
			"skin/3807.txt"
		]
	},
	{
		"name": "PSG-1 - Untranslated1",
		"parts": [
			"skin/3808.txt"
		]
	},
	{
		"name": "Model L - Untranslated1",
		"parts": [
			"skin/3809.txt"
		]
	},
	{
		"name": "M870 - Candy Express",
		"parts": [
			"skin/4.txt"
		]
	},
	{
		"name": "MP7 - Candy Express",
		"parts": [
			"skin/4.txt"
		]
	},
	{
		"name": "m45 - Candy Express",
		"parts": [
			"skin/4.txt"
		]
	},
	{
		"name": "Lewis - Untranslated1",
		"parts": [
			"skin/4001.txt"
		]
	},
	{
		"name": "HK21 - Untranslated1",
		"parts": [
			"skin/4002.txt"
		]
	},
	{
		"name": "CAWS - Untranslated1",
		"parts": [
			"skin/4003.txt"
		]
	},
	{
		"name": "Type 100 - Untranslated2",
		"parts": [
			"skin/4004.txt"
		]
	},
	{
		"name": "Honey Badger - Untranslated1",
		"parts": [
			"skin/4005.txt"
		]
	},
	{
		"name": "Gepard M1 - Untranslated1",
		"parts": [
			"skin/4006.txt"
		]
	},
	{
		"name": "LWMMG - Untranslated1",
		"parts": [
			"skin/4007.txt"
		]
	},
	{
		"name": "DP-12 - Untranslated1",
		"parts": [
			"skin/4201.txt"
		]
	},
	{
		"name": "PA-15 - Untranslated2",
		"parts": [
			"skin/4202.txt"
		]
	},
	{
		"name": "JS 9 - Untranslated2",
		"parts": [
			"skin/4204.txt"
		]
	},
	{
		"name": "MG36 - Untranslated1",
		"parts": [
			"skin/4205.txt"
		]
	},
	{
		"name": "T91 - Untranslated1",
		"parts": [
			"skin/4206.txt"
		]
	},
	{
		"name": "SPP-1 - Untranslated1",
		"parts": [
			"skin/4207.txt"
		]
	},
	{
		"name": "EM-2 - Untranslated1",
		"parts": [
			"skin/4209.txt"
		]
	},
	{
		"name": "MG34 - Untranslated1",
		"parts": [
			"skin/4210.txt"
		]
	},
	{
		"name": "Kar98k - Untranslated1",
		"parts": [
			"skin/4301.txt"
		]
	},
	{
		"name": "M950A - Untranslated1",
		"parts": [
			"skin/4302.txt"
		]
	},
	{
		"name": "Grizzly MkV - Untranslated1",
		"parts": [
			"skin/4303.txt"
		]
	},
	{
		"name": "Zas M21 - Untranslated1",
		"parts": [
			"skin/4304.txt"
		]
	},
	{
		"name": "M1014 - Untranslated1",
		"parts": [
			"skin/4305.txt"
		]
	},
	{
		"name": "Stechkin - Untranslated1",
		"parts": [
			"skin/4306.txt"
		]
	},
	{
		"name": "FNC - Untranslated1",
		"parts": [
			"skin/4308.txt"
		]
	},
	{
		"name": "RMB-93 - Untranslated1",
		"parts": [
			"skin/4309.txt"
		]
	},
	{
		"name": "Makarov - Untranslated1",
		"parts": [
			"skin/4310.txt"
		]
	},
	{
		"name": "Springfield - Classic Witch",
		"parts": [
			"skin/5.txt"
		]
	},
	{
		"name": "ART556 - Haunted Castle",
		"parts": [
			"skin/6.txt"
		]
	},
	{
		"name": "HK416 - Haunted Castle",
		"parts": [
			"skin/6.txt"
		]
	},
	{
		"name": "P7 - Haunted Castle",
		"parts": [
			"skin/6.txt"
		]
	},
	{
		"name": "WA2000 - Haunted Castle",
		"parts": [
			"skin/6.txt"
		]
	},
	{
		"name": "HK416 - Carmilla",
		"parts": [
			"skin/7.txt"
		]
	},
	{
		"name": "M1919A4 - Carmilla",
		"parts": [
			"skin/7.txt"
		]
	},
	{
		"name": "Mk23 - Impish Sweetheart",
		"parts": [
			"skin/8.txt"
		]
	},
	{
		"name": "Skorpion - Crimson Starlet",
		"parts": [
			"skin/801.txt"
		]
	},
	{
		"name": "Springfield - Queen in Radiance",
		"parts": [
			"skin/802.txt"
		]
	},
	{
		"name": "Mosin-Nagant - Moonlit Ocean",
		"parts": [
			"skin/803.txt"
		]
	},
	{
		"name": "WA2000 - Ballroom Interlude",
		"parts": [
			"skin/804.txt"
		]
	},
	{
		"name": "HK416 - Starry Cocoon",
		"parts": [
			"skin/805.txt"
		]
	},
	{
		"name": "M1918 - Tender Nocturne",
		"parts": [
			"skin/806.txt"
		]
	},
	{
		"name": "SR-3MP - Bunny Macchiato",
		"parts": [
			"skin/807.txt"
		]
	},
	{
		"name": "M950A - Concert Diva!",
		"parts": [
			"skin/808.txt"
		]
	},
	{
		"name": "G11 - Neet Zombie",
		"parts": [
			"skin/9.txt"
		]
	}
]});
		
		
		/*var _table_ = document.createElement('table'),
			_tr_ = document.createElement('tr'),
			_th_ = document.createElement('th'),
			_td_ = document.createElement('td'),
			_select_ = document.createElement('select'),
			_option_ = document.createElement('option');*/
		
		//var table = document.getElementById("table");
		//let thead = document.createElement("thead");
		//thead.innerHTML = "<tr><th colspan='"+listOfChapters.length+"'>Pick a chapter</th></tr>"
		//table.appendChild(thead);
		
		//Behold, the most god awful code ever written
		//let tbody = document.createElement('tbody');
		
		/*let trChapterNames = _tr_.cloneNode(false);
		for(i=0;i<listOfChapters.length;i++)
		{
			let td = _td_.cloneNode(false);
			td.appendChild(document.createTextNode(listOfChapters[i]['name']));
			trChapterNames.appendChild(td);
		}
		tbody.appendChild(trChapterNames);*/
		
		var _dropDownTrigger_ = document.createElement('a');
		_dropDownTrigger_.href = "#";
		_dropDownTrigger_.classList.add('dropdown-trigger');
		_dropDownTrigger_.classList.add('btn');
		
		var _dropDown_ = document.createElement('ul');
		_dropDown_.classList.add('dropdown-content');
		
		var _li_ = document.createElement('li'),
			_a_ = document.createElement('a');
		
		//No idea what this is supposed to do.
		_a_.href="#!";
		
		for (const key in listOfChapters)
		{
			let episodeContainer = document.getElementById(key+'Episodes')
			//let trChapterDropdowns = _tr_.cloneNode(false);
			//let trChapterDropdowns = 
			for(i=0;i<listOfChapters[key].length;i++)
			{
				//let td = _td_.cloneNode(false);
				let flexBoxDiv = document.createElement('div');
				/*let select = _select_.cloneNode(false);
				select.setAttribute('id',"selectChapter"+i)
				select.setAttribute('onchange','onChapterSelected(value);');*/
				let dropDownTrigger = _dropDownTrigger_.cloneNode(true)
				dropDownTrigger.setAttribute('data-target','dropdown-'+key+'-'+i)
				dropDownTrigger.innerText=listOfChapters[key][i]['name']
				
				let dropdown = _dropDown_.cloneNode(true);
				dropdown.id = 'dropdown-'+key+'-'+i;
				
				//Generate chapter name first..
				/*let optChName = _option_.cloneNode(false);
				optChName.setAttribute("selected","");
				optChName.setAttribute("disabled","");
				optChName.innerText=listOfChapters[key][i]['name'];
				select.appendChild(optChName);*/
				
				//Now let's do the episodes
				let curChapter = listOfChapters[key][i]['episodes'];
				for(j=0;j<curChapter.length;j++)
				{
					
					let ep = _li_.cloneNode(true);
					ep.innerHTML = "<a href='#!' onclick=\"onChapterSelected('"+getRoutableKeyString(key,i,j)+"')\">"+curChapter[j]['name']+"</a>"
					dropdown.appendChild(ep);
					/*let option = _option_.cloneNode(false);
					option.value=getRoutableKeyString(key,i,j)
					option.innerText=curChapter[j]['name'];
					select.appendChild(option);*/
				}
				//flexBoxDiv.appendChild(select);
				flexBoxDiv.appendChild(dropDownTrigger);
				flexBoxDiv.appendChild(dropdown);
				
				episodeContainer.appendChild(flexBoxDiv);
				//td.appendChild(select);
				//trChapterDropdowns.appendChild(td);
			}
		}
		
		//test = new FilterableList(listOfChapters['side'][0]['episodes'],'name',"sideEpisodesWrapper")

		//tbody.appendChild(trChapterDropdowns);
		
		//table.appendChild(thead);
		//table.appendChild(tbody);
		
		console.log(listOfChapters);
		return listOfChapters;
	}
	
	//materialize.js makes it irrelevant
	/*function showSelectedEpisodes(id)
	{
		let episodesDivs = document.getElementById("Episodes").children;
		for (var i = 0; i < episodesDivs.length;i++){
			if (episodesDivs[i].id == id)
				episodesDivs[i].style="";
			else
				episodesDivs[i].style="display: none;"
		}
		//console.log(episodesDiv.children);
	}*/
	
	//T-Doll search shit
	let frontlinedex = null;
	let CharacterVoice = null;
	
	let dialogueKeysToEnglish = {
		'dialogue1':"Adjutant 1",
		'dialogue2':"Adjutant 2",
		'dialogue3':"Adjutant 3",
		'soulcontract':"Marriage Line",
		'introduce':"Introduction (In the index, but usually identical to obtain)",
		'gain':'When Obtained',
		'allhallows':"During Halloween",
		'christmas':"During Christmas",
		'valentine':"During Valentine's",
		'dialoguewedding':"Adjutant 4 (After Marriage)"
	}
	
	function TDollInfo(dollName)
	{
		/*console.log(dollName);
		console.assert(CharacterVoice)
		console.log(CharacterVoice);*/
		//Destroy everything in here
		let tDollDialogue = document.getElementById('tDollDialogue')
		tDollDialogue.innerHTML = "";
		/*let ul = document.createElement("ul");
		ul.className = 'collapsible'*/
		let _div_ = document.createElement('div');
		_div_.classList.add("card");
		let _cardContent = document.createElement('div');
		_cardContent.classList.add("card-content");
		let dialogue = CharacterVoice[dollName];
		if (dialogue)
		{
			Object.keys(dialogue).forEach(key => {
				let card = _div_.cloneNode(true);
				let cardContent = _cardContent.cloneNode(true);
				let cardTitle = document.createElement('span');
				cardTitle.classList.add('card-title');
				if (dialogueKeysToEnglish[key])
					cardTitle.innerText = dialogueKeysToEnglish[key];
				else
					cardTitle.innerText = key;
				let p = document.createElement('p');
				//console.log(typeof dialogue[key]);
				p.innerHTML= dialogue[key].join([separator = '<br>'])
				cardContent.appendChild(cardTitle);
				cardContent.appendChild(p);
				card.appendChild(cardContent);
				tDollDialogue.appendChild(card);
			});
			
			
			document.getElementById("tDollDialogueActivity").style.display = "inherit";
			document.getElementById('tDollDialogueName').firstChild.textContent=dollName;
			document.getElementById("tDollSearchActivity").style.display="none";
			
			//jump to top of page
			window.location.href="#tDollDialogueActivity"
		}
		else
		{
			//console.log("aa");
			M.toast({html: "T-Doll "+dollName+" not present in json..."})
		}
		//document.getElementById('tDollDialogue').appendChild(_div_);
	}
	function returnTotDollSearch()
	{
		document.getElementById("tDollDialogueActivity").style.display = "none";
		document.getElementById("tDollSearchActivity").style.display="inherit";
	}
	
	function listResults(results)
	{
		//console.log(results);
			/*<li class="collection-item avatar">
		  <img src="images/yuna.jpg" alt="" class="circle">
		  <span class="title">Title</span>
		  <p>First Line <br>
		     Second Line
		  </p>
		  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
		</li>*/
		//Destroy everything inside the div.
		document.getElementById("SearchResultsDiv").innerHTML = "";
		var ul = document.createElement("ul");
		ul.className= "collection";
		ul.id = "SearchResults";
		for (var i=0, n=results.length; i<n; ++i)
		{
			//let result = frontlinedex[results]
			var li = document.createElement("li");
			li.className = "collection-item avatar waves-effect"; //waves-effect waves-light
			li.style.display = '';
			
			var icon = document.createElement("i");
			icon.className = "material-icons circle red";
			li.appendChild(icon);
			
			var span = document.createElement("span");
			span.className = "title";
			span.innerText = results[i].name;
			li.appendChild(span);
			
			var p = document.createElement("p");
			p.innerHTML = results[i].type + " <br> No." + (results[i].num>0 ? results[i].num : "?");
			li.appendChild(p);
			
			//You're probably gonna say this is terrible and blah blah but T-Doll names are unique anyways
			/*for (var j =0; j < frontlinedex.length;j++)
			{
				
			}*/
			if (results[i].internalName)
				li.setAttribute("onclick","TDollInfo(\""+results[i].internalName+"\")")
			
			
			//Handle stars
			var secondaryContent = document.createElement("div");
			secondaryContent.className = "secondary-content";
			num2stars(secondaryContent,results[i].rating)
			li.appendChild(secondaryContent);
			
			ul.appendChild(li);
		}
		
		document.getElementById("SearchResultsDiv").appendChild(ul);
	}
	
	var delayTimer;
	function searchDolls(query)
	{
		clearTimeout(delayTimer);
		delayTimer = setTimeout(function() {
			
			if (query == "" || query == undefined)
			{
				listResults(frontlinedex);
			}
			else
			{
				
				query = query.toLowerCase();
				/*for (var i=0, n=frontlinedex.length; i<n; ++i)
				{
					if ('alias' in frontlinedex[i] && query == frontlinedex[i]['alias'].toLowerCase())
					{
						console.log("Found alias for "+frontlinedex[i]['name']);
						//console.log(frontlinedex[i]);
						listResults([frontlinedex[i]]);
						return true;
					}
				}*/
				console.log("Searching for "+query);
				
				var results = fuse.search(query);
				console.log("Got "+results.length + " results");
				//I don't care if it's slow
				listResults(Array.from(results, r => r['item']));
			}
		}, 300);
	}
	
	function FetchTDollInfo()
	{
		if (frontlinedex != null && CharacterVoice != null)
			return;
		fetch("girlsfrontline-min.json")
		.then(response => response.json())
		.then(json => {
			console.log("girlsfrontline-min loaded!");
			console.log(json);
			
			frontlinedex = json;
			
			/*fetch("gf_flavortext.json").then(response => response.json()).then(json2 => {
				console.log("Bonus information loaded.");
				console.log("Injecting aliases and quotes...");
				bonusdex = json2;
				frontlinedex.forEach(doll => {
					if (doll['name'] in bonusdex)
					{
						if ('alias' in bonusdex[doll['name']])
							doll['alias'] = bonusdex[doll['name']]['alias']
					}
				})
				console.log("Done.");
			});*/
			
			fuse = new Fuse(frontlinedex, {
				keys: ['name']
			})
			//fuse = new Fuse(Object.keys(frontlinedex));
			

			
			listResults(frontlinedex);
		});
		
		fetch('NewCharacterVoice.json')
		.then(response => response.json())
		.then(json => {
			console.log("NewCharacterVoice.json loaded!");
			CharacterVoice = json;
		});
	}
	
	
	//Keep this at the bottom
	window.onload=function()
	{
		generateTables();
		
		document.querySelectorAll('.tabs').forEach(el => {
			var instance = M.Tabs.init(el, null);
			//instance.updateTabIndicator();
		});
		
		document.querySelectorAll('.dropdown-trigger').forEach(elems => {
			var instances = M.Dropdown.init(elems, {constrainWidth:false});
		});
		
		 
		document.querySelectorAll('.collapsible').forEach(elems => {
			var instances = M.Collapsible.init(elems, null);
		});
		
		fetch('portraitInformation.json')
			.then(response => response.json())
			.then(json => {
				console.log("portraitinformation.json loaded!");
				PORTRAITS = json;
			});
		

		//showSelectedEpisodes('mainEpisodes');
	}
	
</script>
<body>
	<!--<h1 id="theTop">GFL Cutscene Intrepeter (very alpha)</h1>
	<!--<h2>...And a way to read the game dialogue.</h2>-->
  <nav class='nav-extended'>
    <div class="nav-wrapper" id='theTop' style="overflow:hidden;">
      <a href="#" class="brand-logo center truncate" style="text-overflow: ellipsis; white-space: nowrap;">GFL Cutscene Intrepeter (very alpha)</a>
      <!--<ul id="nav-mobile" class="right hide-on-med-and-down">
        <li><a href="sass.html">Sass</a></li>
        <li><a href="badges.html">Components</a></li>
        <li><a href="collapsible.html">JavaScript</a></li>
      </ul>-->
    </div>
			<div class="col s12 nav-content">
				<ul class="tabs tabs-transparent">
					<li class="tab col s3"><a href="#mainEpisodesWrapper">Main Story Chapters</a></li>
					<li class="tab col s3"><a href="#eventEpisodesWrapper">Story Events</a></li>
					<li class="tab col s3"><a href="#sideEpisodesWrapper">Side Stories</a></li>
					<li class="tab col s3"><a href="#crossoverEpisodesWrapper">Crossover Stories</a></li>
					<li class="tab col s3"><a href="#TDollStuff" onclick="FetchTDollInfo()">T-Doll Dialogue (WIP)</a></li>
					<li class="tab col s3"><a href="#customCutsceneWrapper">Write your own cutscene (WIP)</a></li>
				</ul>
			</div>
  </nav>
	<div id='chapterSelect' class='navbar-fixed'>
		<div class='row'>
			<!--<a href=#modal1" class="modal-trigger" >Settings</a>-->

			<!--Because materialize.js is stupid -->
			<div class="col s12" id="mainEpisodesWrapper">
				<div class="flex-container col s12" id="mainEpisodes"></div>
			</div>
			
			<div class="col s12" id="eventEpisodesWrapper">
				<div class="flex-container col s12" id="eventEpisodes"></div>
			</div>
			<div class="col s12" id="sideEpisodesWrapper">
				<div class="flex-container col s12" id="sideEpisodes"></div>
			</div>
			<div class="col s12" id="crossoverEpisodesWrapper">
				<div class="flex-container col s12" id="crossoverEpisodes"></div>
			</div>
			<div class="col s12" id="TDollStuff">
				<div id="tDollDialogueActivity" style='display:none;'>
					<nav style="position:initial;">
						<div class="nav-wrapper blue" style="text-align: left;">
						  <a href="#!" onclick="returnTotDollSearch()" class="brand-logo" id='tDollDialogueName'>Insert T-Doll Name Here<i class="material-icons">arrow_back</i></a>
						</div>
					</nav>
					<div id="tDollDialogue">
					
					</div>
				</div>
				<div id="tDollSearchActivity">
					<form action="?">
					<div class="input-field" style="text-align: left;">
						<i class="material-icons prefix">search</i>
						<!--<label class="label-icon" for="search">
						</label>-->
						<input id="search" type="search" oninput="searchDolls(document.getElementById('search').value)" onkeydown="if (event.key == 'Enter') blur(); return;" onsubmit="blur()" required>
						
						<i class="material-icons" onclick="clearSearch()">close</i>
					</div>
					</form>
					
					<div id="SearchResultsDiv"  class="" >
						<p>If you are seeing this it's still loading, please wait 1 second for the JSON to load</a>
						
						<div class="progress">
						  <div class="indeterminate"></div>
						</div>
		    
					</div>
				</div>
			</div>
			<div class="col s12" id="customCutsceneWrapper">
				<div id="customCutscene">
					<p>WORK IN PROGRESS</p>
					<p>Opcode structure isn't finalized, check back later... No, the buttons don't do anything.</p>
					<a class="waves-effect waves-light btn"><i class="material-icons right">folder_open</i>Load .txt</a>
					<a class="waves-effect waves-light btn"><i class="material-icons right">folder_open</i>Load .iop.json</a>
			        <!--<div class="input-field col s12">
						<textarea id="textarea1" class="materialize-textarea"></textarea>
						<label for="textarea1">Textarea</label>
					</div>-->
					<textarea id="textarea1" class="materialize-textarea"></textarea>
				    <div class="card blue-grey darken-1" style="text-align:left">
        				<div class="card-content white-text">
						<span class="card-title">About .txt vs .iop.json</span>
						<p>.txt is the cutscene scripting language GFL uses. The interpreter will always support importing .txt and playing it back.</p>
						<p>.iop.json (<b>I</b>ntermediate <b>Op</b>codes, definitely not a coincidence) is the scripting language designed for the interpreter. It has some advantages compared to the GFL engine:</p>
						<p>- Display more than two characters at a time. Dim multiple charcters.</p>
						<p>- The commands are in english.</p>
						<p>- (Coming soon) branch paths, allowing you to use the interpreter like a VN engine of sorts and write interactive stories</p>
						</div>
					</div>
					<!--<ul class="collapsible">
						<li>
						  <div class="collapsible-header">About .txt vs .iop.json</div>
						  <div class="collapsible-body"></div>
						</li>
					</ul>-->
				</div>
			</div>
				
		</div>
		
	</div>
	
	  <!-- Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Modal Header</h4>
      <p>A bunch of text</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
  </div>
	<!--<h2><a href="#Textboxes">Mobile devices are stupid and the canvas absorbs touch, so click here to jump to the part without the canvas</a></h2>-->
	<!---->

	<h2 id="chapterName">Chapter Name Here</h2>
    <a id="startButton" onclick="initPhaser()" class="waves-effect waves-light btn disabled">Start interactive interpreter (It's like playing the game!)</a>
	<div id="interactiveInterpreterSection" style="display:none;">
		<a id='stopButton' class="waves-effect waves-light btn"> Stop the interpreter (You'll have to refresh the site to start it up again, sorry)</a>
		<p id="curIndexDebug"></p>
		<div id="phaser"></div>
		<br><br><button onclick="showOpcodes('myDIV')">Show converted opcodes (For debugging)</button><br>
		<div id='myDIV' style="display: none;">
			<textarea rows='6' cols='50' id="DebugTextArea"></textarea><br>
			<button onclick="reRunWithNewOpcodes()">Re-run scene with these opcodes</button>
		</div>
	</div>
	<!--<canvas id="myCanvas" width="1280" height="720"></canvas>--><br><br>
    <!--<h1 id="title">This is a header!</h1>-->
	<!--<img src="textbox.png"></img>-->
	<!--<h2><a href="#verySimpleText">Click HERE to jump to the text without any textboxes which is probably what you want anyways</a></h2>
	<h2>Static Textboxes</h2>
	<div id="Textboxes"></div>-->
	<hr>
	<!--<h2></h2>-->
	<!--<form>
	Display Style
	<input type="radio" id="fancy" name="displayStyle" value="male">
	<label for="fancy">Fancy</label>
	<input type="radio" id="simple" name="displayStyle" value="female">
	<label for="simple">Simple</label>
	</form>-->
	  <div class="switch">
    <label>
      Text Only
      <input type="checkbox" onclick="runFromRoutableKeyString()" id="fancyOrNot">
      <span class="lever"></span>
      Fancy
    </label>
  </div>
	<div id="verySimpleText"></div>
	<a class="waves-effect waves-light btn" href="#theTop"><i class="material-icons left">vertical_align_top</i>Back to top</a> <a class="waves-effect waves-light btn" href="#theTop" onclick="goToNextEpisode();"><i class="material-icons left">chevron_right</i>Go to the next cutscene</a>
	<hr>
	<p>Dandelai is my wife, greets to /gfg/, <a href="https://github.com/RhythmLunatic/gfl-cutscene-interpreter">harass me on github (bug reports, check the source code, fork it)</a></p>
	<p>Can someone please fix the horrible UI? I'm a programmer, not a designer. Please fork the source code and make a pull request.</p>
	<p>If you want a feature or something is broken, <b><a href="https://github.com/RhythmLunatic/gfl-cutscene-interpreter/issues">file a bug report</a></b></p>
	<br>
	<!--<a href="https://github.com/RhythmLunatic/Girls-Frontline-Discord-Search">Try out my Girls' Frontline discord bot. T-Doll info, quotes, costumes, and more!</a>-->
</body>
